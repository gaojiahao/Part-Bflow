<!--
  Copyright (c) 2006-2017, JGraph Ltd
  
  Animation example for mxGraph. This example demonstrates using
  SVG animations on edges to visualize the flow in a pipe.
-->
<html>

<head>
    <title>Animation example for mxGraph</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script type="text/javascript" src="grapheditor/www/js/http.js"></script>
    <!-- Sets the basepath for the library if not in same directory -->
    <script type="text/javascript">
        mxBasePath = '../src';
    </script>
    

    <script type="text/javascript">
        // Parses URL parameters. Supported parameters are:
        // - lang=xy: Specifies the language of the user interface.
        // - touch=1: Enables a touch-style user interface.
        // - storage=local: Enables HTML5 local storage.
        // - chrome=0: Chromeless mode.
        var urlParams = (function (url) {
            var result = new Object();
            var idx = url.lastIndexOf('?');

            if (idx > 0) {
                var params = url.substring(idx + 1).split('&');

                for (var i = 0; i < params.length; i++) {
                    idx = params[i].indexOf('=');

                    if (idx > 0) {
                        result[params[i].substring(0, idx)] = params[i].substring(idx + 1);
                    }
                }
            }

            return result;
        })(window.location.href);

        // Default resources are included in grapheditor resources
        mxLoadResources = false;
    </script>

    <!-- Loads and initializes the library -->
    <script type="text/javascript" src="../src/js/mxClient.js"></script>

    <style type="text/css">
        .flow {
            stroke-dasharray: 8;
            animation: dash 0.5s linear;
            animation-iteration-count: infinite;
            stroke-width:2;
        }

        @keyframes dash {
            to {
                stroke-dashoffset: -16;
            }
        }
        .graphToolBar{
            height: 20px;
            padding: 5px;
            background-color: #f0f0f0;
        }

        .graphToolBar button{
            border-style: none;
            margin-right: 5px;
            background-color: transparent;
            cursor: pointer;
        }
    </style>

    <!-- Example code -->
    <script type="text/javascript">

    // Defines an icon for creating new connections in the connection handler.
        // This will automatically disable the highlighting of the source vertex.
        mxConnectionHandler.prototype.connectImage = new mxImage('images/connector.gif', 16, 16);

        // Defines a new class for all icons
        function mxIconSet(state) {
            this.images = [];
            var graph = state.view.graph;

            // Icon1
            var img = mxUtils.createImage('images/copy.png');
            img.setAttribute('title', '查看列表');
            img.style.position = 'absolute';
            img.style.cursor = 'pointer';
            img.style.width = '16px';
            img.style.height = '16px';
            img.style.left = (state.x + state.width) + 'px';
            img.style.top = (state.y + state.height) + 'px';

            mxEvent.addGestureListeners(img,
                mxUtils.bind(this, function (evt) {
                   var listId = state.cell.getAttribute('listId');
                   var listType = state.cell.getAttribute('listType');
                   window.top.changeToAppMain(listType,listId)
                })
            );

            state.view.graph.container.appendChild(img);
            this.images.push(img);

           
        };

        mxIconSet.prototype.destroy = function () {
            if (this.images != null) {
                for (var i = 0; i < this.images.length; i++) {
                    var img = this.images[i];
                    img.parentNode.removeChild(img);
                }
            }

            this.images = null;
        };
        function main(container) {
            var graph = new mxGraph(container);
            graph.setEnabled(false);
            // Defines the tolerance before removing the icons
            var iconTolerance = 20;
            var parent = graph.getDefaultParent();

            graph.getModel().beginUpdate();
            // graph.setTooltips(true);

            document.getElementById('graphToolBar').appendChild(mxUtils.button('放大',
                function (evt) {
                    graph.zoomIn();
                }
            ));

             document.getElementById('graphToolBar').appendChild(mxUtils.button('放小',
                function (evt) {
                    graph.zoomOut();
                }
            ));

            graph.tourl = function (){
                window.top.changeToEditing(urlParams.type, urlParams.id);
            }
               
            document.getElementById('graphToolBar').appendChild(mxUtils.button('编辑',
                function (evt) {
                    // window.top.changeToEditing(urlParams.type, urlParams.id);
                    graph.tourl();
                }
            ));
            


            // Overrides method to provide a cell label in the display
            graph.convertValueToString = function (cell) {
                if (mxUtils.isNode(cell.value)) {
                    if (cell.value.nodeName.toLowerCase() == 'userobject') {
                        return cell.getAttribute('label');
                    }

                }

                return '';
            };

            graph.addListener(mxEvent.CLICK, function (sender, evt) {
                var e = evt.getProperty('event'); // mouse event
                var cell = evt.getProperty('cell'); // cell may be null

                if (cell != null) {
                    // Do something useful with cell and consume the event
                    evt.consume();

                    //移除所有流动样式
                    removeFlowClassForCells(graph.getModel().cells);
                    
                    setFlowClassForCell(cell,true);
                   
                }
            });

            // Shows icons if the mouse is over a cell
            graph.addMouseListener(
                {
                    currentState: null,
                    currentIconSet: null,
                    mouseDown: function (sender, me) {
                        // Hides icons on mouse down
                        if (this.currentState != null) {
                            this.dragLeave(me.getEvent(), this.currentState);
                            this.currentState = null;
                        }
                    },
                    mouseMove: function (sender, me) {
                        if (this.currentState != null && (me.getState() == this.currentState ||
                            me.getState() == null)) {
                            var tol = iconTolerance;
                            var tmp = new mxRectangle(me.getGraphX() - tol,
                                me.getGraphY() - tol, 2 * tol, 2 * tol);

                            if (mxUtils.intersects(tmp, this.currentState)) {
                                return;
                            }
                        }

                        var tmp = graph.view.getState(me.getCell());

                        // Ignores everything but vertices
                        if (graph.isMouseDown || (tmp != null && !graph.getModel().isVertex(tmp.cell))) {
                            tmp = null;
                        }

                        if (tmp != this.currentState) {
                            if (this.currentState != null) {
                                this.dragLeave(me.getEvent(), this.currentState);
                            }

                            this.currentState = tmp;

                            if (this.currentState != null) {
                                this.dragEnter(me.getEvent(), this.currentState);
                            }
                        }
                    },
                    mouseUp: function (sender, me) { },
                    dragEnter: function (evt, state) {
                        if (this.currentIconSet == null) {
                            this.currentIconSet = new mxIconSet(state);
                        }
                    },
                    dragLeave: function (evt, state) {
                        if (this.currentIconSet != null) {
                            this.currentIconSet.destroy();
                            this.currentIconSet = null;
                        }
                    }
                });
            
            try
            {
                $._rfd_http('/H_roleplay-si/trans/getBusinessGroupById', 'GET', {
                    businessGroupId: urlParams.id
                }, true, function (res) {
                    var parser = new DOMParser();
                    var root = parser.parseFromString(res.businessGroupXml, "text/xml").documentElement;
                    var dec = new mxCodec(root.ownerDocument);

                    dec.decode(root, graph.getModel());
                    graph.getModel().endUpdate();

                });
            	// read(graph, 'animation.xml');
            }
            finally
            {
            	// Updates the display
            	graph.getModel().endUpdate();
            }

           

           

            function read(graph, filename) {
                var req = mxUtils.load(filename);
                var root = req.getDocumentElement();
                var dec = new mxCodec(root.ownerDocument);

                dec.decode(root, graph.getModel());
            };

            function setFlowClassForCell(cell,flowFlag) {
              for (var i in cell.edges) {
                    var state = graph.view.getState(cell.edges[i]);

                    if(flowFlag){
                        state.shape.node.getElementsByTagName('path')[0].removeAttribute('visibility');
                        state.shape.node.getElementsByTagName('path')[0].setAttribute('stroke-width', '5');
                        state.shape.node.getElementsByTagName('path')[0].setAttribute('stroke', '#fff');
                        state.shape.node.getElementsByTagName('path')[1].setAttribute('class', 'flow');    
                    }else{
                        state.shape.node.getElementsByTagName('path')[1].classList.remove('flow');
                    }
                    
                }  
            }

            function removeFlowClassForCells(cells) {
                var cell,i;

                for(i in cells){
                    cell = cells[i];

                    if(cell.edges){
                       setFlowClassForCell(cell,false);
                    }
                }
            }
        };
    </script>
</head>

<!-- Page passes the container for the graph to the program -->

<body onload="main(document.getElementById('graphContainer'))">

    <div id='graphToolBar' class="graphToolBar"></div>
    <!-- Creates a container for the graph with a grid wallpaper -->
    <div id="graphContainer" style="position:relative;overflow:hidden;background:url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGRlZnM+PHBhdHRlcm4gaWQ9ImdyaWQiIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgcGF0dGVyblVuaXRzPSJ1c2VyU3BhY2VPblVzZSI+PHBhdGggZD0iTSAwIDEwIEwgNDAgMTAgTSAxMCAwIEwgMTAgNDAgTSAwIDIwIEwgNDAgMjAgTSAyMCAwIEwgMjAgNDAgTSAwIDMwIEwgNDAgMzAgTSAzMCAwIEwgMzAgNDAiIGZpbGw9Im5vbmUiIHN0cm9rZT0iI2UwZTBlMCIgb3BhY2l0eT0iMC4yIiBzdHJva2Utd2lkdGg9IjEiLz48cGF0aCBkPSJNIDQwIDAgTCAwIDAgMCA0MCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjZTBlMGUwIiBzdHJva2Utd2lkdGg9IjEiLz48L3BhdHRlcm4+PC9kZWZzPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9InVybCgjZ3JpZCkiLz48L3N2Zz4=);cursor:default;margin: 0 auto;">
    </div>
</body>

</html>